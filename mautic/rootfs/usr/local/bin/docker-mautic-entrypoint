#!/usr/bin/env sh
set -e

MAUTIC_HOME=${MAUTIC_HOME:-'/var/www/html'}
AUTOLOAD_FILE="${MAUTIC_HOME}/vendor/autoload.php"

if [ -n "$(ls -A """${MAUTIC_HOME}""" 2>/dev/null)" ]
then
  echo >&2 "📂 Mautic app exists in ${MAUTIC_HOME}"
  rm -Rf "${MAUTIC_HOME}/var/cache/prod"
  mkdir -p "${MAUTIC_HOME}/var/cache/prod"
  chmod 777 "${MAUTIC_HOME}/var/cache/prod"
else
  echo >&2 "📁 Moving Mautic to ${MAUTIC_HOME}"
  mkdir -p "${MAUTIC_HOME}"
  cp -R /usr/src/mautic/. "${MAUTIC_HOME}"
  mkdir -p "${MAUTIC_HOME}/var/cache/prod"
  chmod 777 "${MAUTIC_HOME}/var/cache/prod"
fi

if [ ! -f "${AUTOLOAD_FILE}" ]; then
   echo >&2 "🏗️ Mautic not ready. Making it so."
   cd "${MAUTIC_HOME}"
   compose install
fi

# Cleanup cron
echo >&2 "⏲️ Cleaning up cron table"
cp /usr/src/mautic-cron/mautic /etc/cron.d/mautic


echo >&2 "🆗 Ready"
# first arg is `-f` or `--some-option`
if [ "${1#-}" != "$1" ]; then
        set -- /docker-entrypoint.sh "$@"
fi

/docker-entrypoint.sh "$@"